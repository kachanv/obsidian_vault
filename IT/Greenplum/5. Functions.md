## СОЗДАНИЕ ФУНКЦИЙ
based on GP 5, PG 8.3

- может существовать несколько функций с одним названием (схема + имя), но с разным количеством атрибутов
- использование *CREATE OR REPLACE* возможно если не меняется набор и тип аргументов и return-ов
- при удалении функции необходимо удалять все ссылающиеся на F объекты (таблицы, view, triggers etc.)
- функция в PG всегда выполняется в рамках одной транзакции. Если нужно управлять транзакциями используй хранимые процедуры (PG 11) . Или блок `EXCEPTION`- который открывает отдельную транзакцию.
- в момент создания функция компилируется, в момент запуска используется скомпилированный объект
- *trigger* в F не поддерживаются 
- *coursor* в F может двигаться только вперед (*forward-only*)
	*coursor* - ссылка на контекстную область памяти, позволяющая обращаться к набору данных, как с ассоциативному массиву
* *coursor* в F не может менять данные на ходу (*update*/*delete*)
* `BEGIN...END` - только декоративная группировка, хотя переменные внутри создаются заново
* если характеристика изменчивости F позволяет PG будет кэшировать план запроса в рамках сессии. Что позволяет не читать SK каждый раз.
### Блоки DDL создания функции
* *name*
блог аргументов функции
* *argmode*: `in`, `out`, `inout`, `variadic`
* *argname*
* *argtype*
* *defexpr* - выражение рассчитывающее default
блок RETURN
блок можно опустить если используются `out`, `inout` аргументы
* *rettype* - тип данных, возвращаемых F. Если не нужно ничего возвращать используется `void`. 
* *SETOF* - указатель что F вернет набор аргументов (строку), а не одно значение конкретного типа.

* *langname* - на каком языку будет написано тело F
* *IMMUTABLE* | *STABLE* | *VOLATILE* (def) - указатель характеристики изменчивости
* *CALLED ON NULL INPUT*(def) | *RETURNS NULL ON NULL INPUT*  | *STRICT*  - указатель, может ли функция содержать NULL аргумент и поведение при этом
* *NO SQL* | *CONTAINS SQL* | *READS SQL DATA* | *MODIFIES SQL*  - указатель, содержит ли F SQL запросы и есть ли в них update/insert
* *[EXTERNAL] SECURITY INVOKER* (def) | *[EXTERNAL] SECURITY DEFINER* -  запустить с правами текущего user или с правами user создавшего функцию
* *COST* - стоимость в попугаях за возврат F 1 строки

блок SET
блок позволяет изменить параметр конфигурации для сессии запускающей F

### Характеристики изменчивости
 F бывают *IMMUTABLE* | *STABLE* | *VOLATILE* - характеристики изменчивости  
    при создании F указывается её изменчивость, это позволяет оптимизатору лучше работать с функцией т.к. он знает на сколько она "строгая" (кэширование результатов, использование индексов и т.п.)
    * *IMMUTABLE*
        - immutable функция, нет ограничений.
        - не изменяет состояние БД и данных
        - не ищет информацию в БД
        - всегда возвращает одинаковое значение при одном наборе аргументов (immutable)
        - оптимизатор может предварительно вычислить значение функции и далее заменять без выполнения. Кэширование на уровне схемы.
        - в PG: видимость изменений F - на момент старта транзакции
    - *STABLE*
        - не изменяет состояние БД и данных
        - в рамках одной транзакции, возвращает один результат при одинаковом наборе аргументов.
        - может искать информацию в БД.
        - кэширование на уровне транзакции.
        - не иммутабельна, т.е. если используется не в блоке *FROM* не может выполняться на нодах независимо или в скриптах меняющих состояние данных или БД. Выполняется на master. Если выполняется в блоке *FROM* - может выполнятся на сегментах.
        - в PG: видимость изменений F - на момент старта транзакции
    - *VOLATILE* (def)
	    - оптимизатор не делает никаких предположений, функция честно вычисляется каждый вызов.
        - не иммутабельна, т.е. если используется не в блоке *FROM* не может выполняться на нодах независимо или в скриптах меняющих состояние данных или БД. Выполняется на master. Если выполняется в блоке *FROM* - может выполнятся на сегментах.
        - в PG: видимость изменений F - на момент старта запроса

F не может быть использована в запросе `select func() from table`  если выполняются 3 условия:
* `table` - distributed таблица
* `func` использует данные из другой distributed таблицы
* `func` возвращает более 1 строки или берет аргументы из `table`
### Запуск функций на других ЯП
* все библиотеки и весь исполняемый код должен находится на всех сегментах GP +master в одной директории и она должна быть добавлена в соотв. *_PATH*
### DO
* выполняет временную анонимную функцию aka блок кода (не обяpательно *pl/pgsql*, может быть ещё *python* и *perl*)
* без аргументов, возвращает *void*
* не создает объект в системном каталоге
* компиляция и выполнение происходят в один шаг
